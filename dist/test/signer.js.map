{"version":3,"sources":["../../src/signer.js"],"names":["CmsSigner","credentials","request","date","Date","globalQuery","accessKeyId","String","getTime","randomNumbers","toISOString","replace","parts","Object","keys","forEach","key","push","encodeURIComponent","path","indexOf","join","signature","sign","secretAccessKey","stringToSign","count","num","i","Math","floor","random","r","s","method","canonicalizedQueryString","that","querystring","split","resource","body","resources","arrayEach","call","param","pos","name","slice","value","undefined","decodeURIComponent","sort","a","b","length","cmsEscape","array","iterFunction","idx","hasOwnProperty","ret","parseInt","clearString","secret","string","hmac","digest","fn","jsSHA","shaObj","setHMACKey","update","getHMAC"],"mappings":"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","file":"signer.js","sourcesContent":["import {SHA} from \"./sha1\";\n\nexport class CmsSigner {\n\n    constructor(credentials,request) {\n        this.credentials = credentials;\n        this.request = request;\n    }\n\n    addAuthorization() {\n        var date = new Date();\n        var globalQuery = {\n            'Format': 'JSON',\n            'Version': '2018-03-08',\n            'AccessKeyId': this.credentials.accessKeyId,\n            'SignatureMethod': 'HMAC-SHA1',\n            'SignatureVersion': '1.0',\n            'SignatureNonce': String(date.getTime()) + this.randomNumbers(4),\n            'Timestamp': date.toISOString().replace(/\\.\\d{3}/, '')\n        };\n\n        var parts = [];\n        Object.keys(globalQuery).forEach(function (key) {\n            parts.push(key + '=' + encodeURIComponent(globalQuery[key]));\n        });\n        this.request.path += (this.request.path.indexOf('?') == -1 ? '?' : '&') + parts.join('&');\n        var signature = this.sign(this.credentials.secretAccessKey, this.stringToSign());\n        this.request.path += '&Signature=' + encodeURIComponent(signature);\n    }\n\n    randomNumbers(count) {\n        var num = '';\n        for (var i = 0; i < count; i++) {\n            num += Math.floor(Math.random() * 10);\n        }\n        return num;\n    }\n\n    stringToSign() {\n        var r = this.request;\n        var s = r.method + '&%2F&' + encodeURIComponent(this.canonicalizedQueryString());\n        return s;\n    }\n\n    canonicalizedQueryString() {\n        var that = this;\n        var r = this.request;\n        var querystring = r.path.split('?')[1];\n        var resource = '';\n        if (r.body) {\n            querystring += '&' + r.body;\n        }\n        if (querystring) {\n            var resources = [];\n            this.arrayEach.call(this, querystring.split('&'), function (param) {\n                var pos = param.indexOf('=');\n                var name = param.slice(0, pos);\n                var value = param.slice(pos + 1);\n                var resource = {name: name};\n                if (value !== undefined) {\n                    resource.value = decodeURIComponent(value);\n                }\n                resources.push(resource);\n            });\n            resources.sort(function (a, b) {\n                return a.name < b.name ? -1 : 1;\n            });\n            if (resources.length) {\n                querystring = [];\n                this.arrayEach(resources, function (resource) {\n                    if (resource.value === undefined)\n                        querystring.push(that.cmsEscape(resource.name));\n                    else\n                        querystring.push(that.cmsEscape(resource.name) + '=' + that.cmsEscape(resource.value));\n                });\n                resource += querystring.join('&');\n            }\n        }\n        return resource;\n    }\n\n    arrayEach(array, iterFunction) {\n        for (var idx in array) {\n            if (array.hasOwnProperty(idx)) {\n                var ret = iterFunction.call(this, array[idx], parseInt(idx, 10));\n                if (ret === {}) break;\n            }\n        }\n    }\n\n    cmsEscape(clearString) {\n        return encodeURIComponent(clearString)\n            .replace(/\\!/gi, '%21')\n            .replace(/\\'/gi, '%27')\n            .replace(/\\(/gi, '%28')\n            .replace(/\\)/gi, '%29')\n            .replace(/\\*/gi, '%2A')\n    }\n\n    sign(secret, string) {\n        return this.hmac(secret + '&', string, 'base64', 'sha1');\n    }\n\n    hmac(key, string, digest, fn) {\n        if (!digest) digest = 'binary';\n\n        if (digest === 'buffer') {\n            digest = undefined;\n            // todo: 不支持 buffer 类型的 hash\n            return \"\";\n        }\n\n        if (!fn) fn = 'sha256';\n\n        if (typeof string != 'string') {\n            //string = new Buffer(string);\n            // todo: 目前只支持 string\n            return \"\";\n        }\n        var jsSHA = SHA();\n        var shaObj;\n        switch (fn) {\n            case \"md5\":\n                // todo: 不支持 md5\n                return \"\";\n            case \"sha1\":\n                shaObj = new jsSHA(\"SHA-1\", \"TEXT\");\n                break;\n            case \"sha256\":\n                shaObj = new jsSHA(\"SHA-256\", \"TEXT\");\n                break;\n            case \"sha512\":\n                shaObj = new jsSHA(\"SHA-512\", \"TEXT\");\n                break;\n            default:\n                return \"\";\n        }\n\n        shaObj.setHMACKey(key, \"TEXT\");\n\n        shaObj.update(string);\n\n        switch (digest) {\n            case \"binary\":\n                return shaObj.getHMAC(\"BYTES\");\n            case \"hex\":\n                return shaObj.getHMAC(\"HEX\");\n            case \"base64\":\n                return shaObj.getHMAC(\"B64\");\n            default:\n                return \"\";\n        }\n    }\n}\n"]}