{"version":3,"sources":["../../src/query_ctrl.js"],"names":["GenericDatasourceQueryCtrl","$scope","$injector","scope","project_list","metric_list","metric_name_list","fieldName","panel","columns","dimensionValues","oldDimensionKeys","init","ListProjectDetail","target","project","metric","fieldNames","selectedFieldNames","periods","period","dimensions","dimKVs","dimensionKeys","projectChanged","checkProject","title","key","value","onChangeInternal","ListMetricDetail","metricChanged","checkMetric","length","metrics","_","each","push","uniq","panelTitle","includes","ensureDimension","getDimensionValues","dimensionKey","isEqual","fieldNameChanged","oldList","angular","copy","text","uniqBy","removeSelectedField","$event","feild","without","remove","onTargetBlur","index","len","start","end","splice","dimValue","dimKV","type","split","dimension","dimKs","kv","nextKey","panelCtrl","refresh","dimKeyIndex","indexOf","query","Project","Metric","Period","now","Date","StartTime","getTime","EndTime","Dimensions","slice","NextKey","datasource","listDimensionValues","then","dimData","result","data","ErrorCode","Success","Resource","Resources","Statistics","intersection","filter","Periods","tempPeriod","loadDefaultPeroid","QueryCtrl","templateUrl"],"mappings":";;;;;;;;;AAAA;;AACA;;;;;;;;IAEaA,0B,WAAAA,0B;;;AAEZ,qCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,sJAExBD,MAFwB,EAEhBC,SAFgB;;AAG9B,QAAKC,KAAL,GAAaF,MAAb;AACA,QAAKG,YAAL,GAAoB,MAAKA,YAAL,IAAqB,EAAzC;AACA,QAAKC,WAAL,GAAmB,MAAKA,WAAL,IAAoB,EAAvC;AACA,QAAKC,gBAAL,GAAwB,MAAKA,gBAAL,IAAyB,EAAjD;AACA,QAAKC,SAAL,GAAiB,MAAKA,SAAL,IAAkB,EAAnC;AACA,QAAKC,KAAL,CAAWC,OAAX,GAAqB,MAAKD,KAAL,CAAWC,OAAX,IAAsB,EAA3C;AACA,QAAKC,eAAL,GAAuB,MAAKA,eAAL,IAAwB,EAA/C;AACA,QAAKC,gBAAL,GAAwB,EAAxB;;AAEA,QAAKC,IAAL,GAAY,YAAW;AACtB,QAAKC,iBAAL;AACA,QAAKC,MAAL,CAAYC,OAAZ,GAAsB,KAAKD,MAAL,CAAYC,OAAZ,IAAuB,EAA7C;AACA,QAAKD,MAAL,CAAYE,MAAZ,GAAqB,KAAKF,MAAL,CAAYE,MAAZ,IAAsB,EAA3C;AACA,QAAKF,MAAL,CAAYG,UAAZ,GAAyB,KAAKH,MAAL,CAAYG,UAAZ,IAA0B,EAAnD;AACA,QAAKH,MAAL,CAAYI,kBAAZ,GAAiC,KAAKJ,MAAL,CAAYI,kBAAZ,IAAkC,EAAnE;AACA,QAAKJ,MAAL,CAAYK,OAAZ,GAAsB,KAAKL,MAAL,CAAYK,OAAZ,IAAuB,CAAC,IAAD,CAA7C;AACA,QAAKL,MAAL,CAAYM,MAAZ,GAAqB,KAAKN,MAAL,CAAYM,MAAZ,IAAsB,EAA3C;AACA,QAAKN,MAAL,CAAYO,UAAZ,GAAyB,KAAKP,MAAL,CAAYO,UAAZ,IAA0B,EAAnD;AACA,QAAKP,MAAL,CAAYQ,MAAZ,GAAqB,KAAKR,MAAL,CAAYQ,MAAZ,IAAsB,EAA3C;AACA,QAAKR,MAAL,CAAYS,aAAZ,GAA4B,KAAKT,MAAL,CAAYS,aAAZ,IAA6B,EAAzD;AACA,GAXD;AAYA,QAAKX,IAAL;;AAEA,QAAKY,cAAL,GAAsB,YAAW;AAChC,OAAG,CAAC,KAAKC,YAAL,EAAJ,EAAyB;AACxB,SAAKjB,KAAL,CAAWkB,KAAX,GAAmB,EAAnB;AACA,SAAKZ,MAAL,CAAYE,MAAZ,GAAqB,EAArB;AACA,SAAKX,WAAL,GAAmB,EAAnB;AACA,SAAKS,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,SAAKJ,MAAL,CAAYM,MAAZ,GAAqB,EAArB;AACA,SAAKN,MAAL,CAAYK,OAAZ,GAAsB,EAAtB;AACA,SAAKL,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,SAAKP,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,UAAK,KAAKb,MAAL,CAAYS,aAAZ,CAA0B,CAA1B,CADgB;AAErBK,YAAO;AAFc,KAAD,CAArB;AAIA,SAAKC,gBAAL;AACA;AACA;AACD,QAAKC,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,EAA3C;AACA,GAjBD;;AAmBA,QAAKgB,aAAL,GAAqB,YAAW;AAC/B,OAAG,CAAC,KAAKC,WAAL,EAAJ,EAAwB;AACvB,SAAKxB,KAAL,CAAWkB,KAAX,GAAmB,EAAnB;AACA,SAAKZ,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,SAAKJ,MAAL,CAAYM,MAAZ,GAAqB,EAArB;AACA,SAAKN,MAAL,CAAYK,OAAZ,GAAsB,EAAtB;AACA,SAAKL,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,SAAKP,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,UAAK,KAAKb,MAAL,CAAYS,aAAZ,CAA0B,CAA1B,CADgB;AAErBK,YAAO;AAFc,KAAD,CAArB;AAIA,SAAKE,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,EAA3C;AACA,SAAKc,gBAAL;AACA;AACA;AACD,QAAKC,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,KAAKD,MAAL,CAAYE,MAAvD;AACA;AACA,OAAG,CAAC,KAAKV,gBAAN,IAA0B,KAAKA,gBAAL,CAAsB2B,MAAtB,KAAiC,CAA9D,EAAiE;AAChE,QAAIC,UAAU,EAAd;AACAC,MAAEC,IAAF,CAAO,KAAK/B,WAAZ,EAAyB,kBAAU;AAClC6B,aAAQG,IAAR,CAAarB,MAAb;AACA,KAFD;AAGA,SAAKV,gBAAL,GAAwB6B,EAAEG,IAAF,CAAOJ,OAAP,CAAxB;AACA;AACD,OAAIK,aAAa,KAAK/B,KAAL,CAAWkB,KAA5B;AACA,OAAG,CAACa,UAAD,IAAeA,eAAe,EAA9B,IAAoCA,eAAe,aAAnD,IACFJ,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAA7C,CADD,EACsD;AACrD,SAAKlB,KAAL,CAAWkB,KAAX,GAAmB,KAAKZ,MAAL,CAAYE,MAA/B;AACA;;AAED,QAAKR,KAAL,CAAWC,OAAX,GAAqB,EAArB;AACA,GA/BD;;AAiCA,QAAKgC,eAAL,GAAuB,YAAW;AAAA;;AACjC,OAAG,CAAC,KAAKhB,YAAL,EAAJ,EAAyB;AACxB;AACA;AACD,OAAIF,gBAAgB,KAAKT,MAAL,CAAYS,aAAhC;AACA,OAAGA,cAAcU,MAAd,KAAyB,CAA5B,EAA+B;AAC9BE,MAAEC,IAAF,CAAOb,aAAP,EAAsB,wBAAgB;AACrC,YAAKmB,kBAAL,CAAwBC,YAAxB;AACA,KAFD;AAGA;AACD,OAAG,CAACR,EAAES,OAAF,CAAUrB,aAAV,EAAyB,KAAKZ,gBAA9B,CAAJ,EAAqD;AACpD,SAAKG,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,UAAKJ,cAAc,CAAd,CADgB;AAErBK,YAAO;AAFc,KAAD,CAArB;AAIA,SAAKd,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,SAAKJ,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,SAAKV,gBAAL,GAAwBY,aAAxB;AACA;AACD,QAAKM,gBAAL;AACA,GApBD;;AAsBA,QAAKgB,gBAAL,GAAwB,UAAStC,SAAT,EAAoB;AAC3C,OAAG,CAACA,SAAD,IAAc,CAAC4B,EAAEK,QAAF,CAAW,KAAK1B,MAAL,CAAYG,UAAvB,EAAmCV,SAAnC,CAAlB,EAAiE;AAChE;AACA;AACD,OAAIuC,UAAUC,QAAQC,IAAR,CAAa,KAAKlC,MAAL,CAAYI,kBAAzB,CAAd;AACA4B,WAAQT,IAAR,CAAa9B,SAAb;AACA,QAAKO,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAEG,IAAF,CAAOQ,OAAP,CAAjC;AACA,QAAKjB,gBAAL;AACA,QAAKrB,KAAL,CAAWC,OAAX,CAAmB4B,IAAnB,CAAwB;AACvBY,UAAM1C,SADiB;AAEvBqB,WAAOrB;AAFgB,IAAxB;AAIA,QAAKC,KAAL,CAAWC,OAAX,GAAqB0B,EAAEe,MAAF,CAAS,KAAK1C,KAAL,CAAWC,OAApB,EAA6B,MAA7B,CAArB;AACA,QAAKF,SAAL,GAAiB,EAAjB;AACA,GAdD;;AAgBA,QAAK4C,mBAAL,GAA2B,UAASC,MAAT,EAAiBC,KAAjB,EAAwB;AAClD,QAAKvC,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAEmB,OAAF,CAAU,KAAKxC,MAAL,CAAYI,kBAAtB,EAA0CmC,KAA1C,CAAjC;AACAlB,KAAEoB,MAAF,CAAS,KAAK/C,KAAL,CAAWC,OAApB,EAA6B;AAC5BwC,UAAMI,KADsB;AAE5BzB,WAAOyB;AAFqB,IAA7B;AAIA,QAAKxB,gBAAL;AACA,GAPD;;AASA,QAAK2B,YAAL,GAAoB,UAAS7B,GAAT,EAAc8B,KAAd,EAAqB;AAAA;;AACxC;AACA,OAAIC,MAAM,KAAK5C,MAAL,CAAYS,aAAZ,CAA0BU,MAApC;AACA,OAAGwB,SAASC,GAAZ,EAAiB;AAChB;AACA;;AAED;AACA,OAAIC,QAAQF,QAAQ,CAApB;AACA,OAAIG,MAAMF,MAAMD,KAAhB;AACA,QAAK3C,MAAL,CAAYQ,MAAZ,CAAmBuC,MAAnB,CAA0BF,KAA1B,EAAiCC,GAAjC;;AAEA;AACA,OAAIE,WAAW,KAAKhD,MAAL,CAAYQ,MAAZ,CAAmBmC,KAAnB,EAA0B7B,KAAzC;AACA,OAAG,CAACkC,QAAJ,EAAc;AACb,SAAKjC,gBAAL;AACA;AACA;;AAED;AACA,QAAKf,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACAc,KAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYQ,MAAnB,EAA2B,iBAAS;AACnC,WAAKR,MAAL,CAAYO,UAAZ,CAAuBgB,IAAvB,CAA4B0B,KAA5B;AACA,IAFD;;AAIA;AACA,OAAG,KAAKvD,KAAL,CAAWwD,IAAX,KAAoB,OAAvB,EAAgC;AAC/B,QAAG,KAAK1D,gBAAL,CAAsB2B,MAAtB,KAAiC,CAApC,EAAuC;AACtC,UAAKpB,iBAAL;AACA,UAAKiB,gBAAL;AACA;AACD;AACA,QAAG,CAAC,KAAKtB,KAAL,CAAWkB,KAAZ,IACF,KAAKlB,KAAL,CAAWkB,KAAX,KAAqB,EADnB,IAEF,KAAKlB,KAAL,CAAWkB,KAAX,KAAqB,aAFnB,IAGFS,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAA7C,CAHE,IAIFS,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAAX,CAAiBuC,KAAjB,CAAuB,GAAvB,EAA4B,CAA5B,CAAlC,CAJD,EAIoE;AACnE,UAAKzD,KAAL,CAAWkB,KAAX,GAAmB,KAAKZ,MAAL,CAAYE,MAA/B;AACAmB,OAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYO,UAAnB,EAA+B,qBAAa;AAC3C,aAAKb,KAAL,CAAWkB,KAAX,IAAqB,MAAMwC,UAAUtC,KAArC;AACA,MAFD;AAGA;AACD;;AAED,QAAKC,gBAAL;;AAEA;AACA,OAAIsC,QAAQ,EAAZ;AACAhC,KAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYQ,MAAnB,EAA2B,cAAM;AAChC6C,UAAM9B,IAAN,CAAW+B,GAAGzC,GAAd;AACA,IAFD;AAGAwC,WAAQhC,EAAEG,IAAF,CAAO6B,KAAP,CAAR;AACA,OAAIE,UAAU,KAAKvD,MAAL,CAAYS,aAAZ,CAA0BkC,QAAQ,CAAlC,CAAd;AACA,OAAG,CAACY,OAAD,IAAYlC,EAAEK,QAAF,CAAW2B,KAAX,EAAkBE,OAAlB,CAAf,EAA2C;AAC1C;AACA;;AAED;AACA,QAAKvD,MAAL,CAAYQ,MAAZ,CAAmBe,IAAnB,CAAwB;AACvBV,SAAK0C,OADkB;AAEvBzC,WAAO;AAFgB,IAAxB;;AAKA,QAAKlB,eAAL,GAAuB,EAAvB;AACA,GAhED;AA7H8B;AA8L9B;;;;qCAEkB;AAClB,OAAG,KAAKI,MAAL,CAAYI,kBAAZ,CAA+Be,MAA/B,GAAwC,CAAxC,IACF,KAAKnB,MAAL,CAAYC,OADV,IACqB,KAAKD,MAAL,CAAYE,MADpC,EAC4C;AAC3C,SAAKsD,SAAL,CAAeC,OAAf,GAD2C,CACjB;AAC1B;AACD;;;iCAEc;AACd,UAAO,KAAKnE,YAAL,CAAkB6B,MAAlB,GAA2B,CAA3B,IACN,KAAKnB,MAAL,CAAYC,OADN,IAENoB,EAAEK,QAAF,CAAW,KAAKpC,YAAhB,EAA8B,KAAKU,MAAL,CAAYC,OAA1C,CAFD;AAGA;;;gCAEa;AACb,UAAO,KAAKV,WAAL,CAAiB4B,MAAjB,GAA0B,CAA1B,IACN,KAAKnB,MAAL,CAAYE,MADN,IAENmB,EAAEK,QAAF,CAAW,KAAKnC,WAAhB,EAA6B,KAAKS,MAAL,CAAYE,MAAzC,CAFD;AAGA;;;qCAEkBqD,O,EAAS;AAAA;;AAC3B,OAAG,CAACA,OAAD,IAAY,CAAC,KAAKvD,MAAL,CAAYC,OAAzB,IAAoC,KAAKD,MAAL,CAAYC,OAAZ,KAAwB,EAA5D,IAAkE,CAAC,KAAKD,MAAL,CAAYE,MAA/E,IAAyF,KAAKF,MAAL,CAAYE,MAAZ,KAAuB,EAAnH,EAAuH;AACtH;AACA;AACD,OAAIwD,cAAcrC,EAAEsC,OAAF,CAAU,KAAK3D,MAAL,CAAYS,aAAtB,EAAqC8C,OAArC,CAAlB;AACA,OAAGG,eAAe,CAAf,IAAoB,KAAK1D,MAAL,CAAYS,aAAZ,CAA0BiD,cAAc,CAAxC,EAA2C5C,KAA3C,KAAqD,WAA5E,EAAyF;AACxF;AACA;AACD,OAAI8C,QAAQ,EAAZ;AACAA,SAAMC,OAAN,GAAgB,KAAK7D,MAAL,CAAYC,OAA5B;AACA2D,SAAME,MAAN,GAAe,KAAK9D,MAAL,CAAYE,MAA3B;AACA0D,SAAMG,MAAN,GAAe,KAAK/D,MAAL,CAAYM,MAA3B;AACA,OAAI0D,MAAM,IAAIC,IAAJ,EAAV;AACAL,SAAMM,SAAN,GAAkBF,IAAIG,OAAJ,KAAgB,OAAO,EAAP,GAAY,EAA9C;AACAP,SAAMQ,OAAN,GAAgBJ,IAAIG,OAAJ,EAAhB;AACAP,SAAMS,UAAN,GAAmB,EAAnB;AACAT,SAAMS,UAAN,GAAmBhD,EAAEiD,KAAF,CAAQ,KAAKtE,MAAL,CAAYO,UAApB,EAAgC,CAAhC,EAAmCmD,WAAnC,CAAnB;AACAE,SAAMW,OAAN,GAAgBhB,OAAhB;;AAEA,QAAKiB,UAAL,CAAgBC,mBAAhB,CAAoCb,KAApC,EAA2Cc,IAA3C,CAAgD,kBAAU;AACzD,QAAI9E,kBAAkB,EAAtB;AACA,QAAI+E,UAAUC,OAAOC,IAArB;AACA,QAAG,CAACF,OAAD,IAAYA,QAAQxD,MAAR,KAAmB,CAAlC,EAAqC;AACpCvB,qBAAgB2B,IAAhB,CAAqB,WAArB;AACA,KAFD,MAEO;AACN3B,uBAAkB+E,OAAlB;AACA;AACD,WAAK/E,eAAL,GAAuBA,eAAvB;AACA,IATD;AAUA;;;sCAEmB;AAAA;;AACnB,QAAK4E,UAAL,CAAgBzE,iBAAhB,GAAoC2E,IAApC,CAAyC,kBAAU;AAClD,WAAKpF,YAAL,GAAoBsF,MAApB;AACA,IAFD;AAGA;;;mCAEgB3E,O,EAASC,M,EAAQ;AAAA;;AACjC,QAAKsE,UAAL,CAAgBxD,gBAAhB,CAAiC;AAChC6C,aAAS5D,OADuB;AAEhC6D,YAAQ5D;AAFwB,IAAjC,EAGGwE,IAHH,CAGQ,kBAAU;AACjB,QAAIG,OAAOD,OAAOC,IAAlB;AACA,QAAGA,KAAKC,SAAL,KAAmB,GAAnB,IAA0BD,KAAKE,OAAL,KAAiB,IAA9C,EAAoD;AACnD,SAAG7E,UAAU,EAAb,EAAiB;AAChB,UAAI8E,WAAWH,KAAKI,SAAL,CAAeD,QAAf,CAAwB,CAAxB,CAAf;AACA,aAAKhF,MAAL,CAAYG,UAAZ,GAAyB6E,SAASE,UAAT,CAAoB/B,KAApB,CAA0B,GAA1B,CAAzB;AACA,aAAKnD,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAE8D,YAAF,CAAe,OAAKnF,MAAL,CAAYI,kBAA3B,EAA+C,OAAKJ,MAAL,CAAYG,UAA3D,CAAjC;AACA,UAAIkE,aAAa,EAAjB;AACA,UAAGW,SAASX,UAAT,CAAoBV,OAApB,CAA4B,GAA5B,MAAqC,CAAC,CAAzC,EAA4C;AAC3CU,kBAAW9C,IAAX,CAAgByD,SAASX,UAAzB;AACA,OAFD,MAEO;AACNA,oBAAaW,SAASX,UAAT,CAAoBlB,KAApB,CAA0B,GAA1B,CAAb;AACA;AACD,aAAKnD,MAAL,CAAYS,aAAZ,GAA4BY,EAAE+D,MAAF,CAASf,UAAT,EAAqB,eAAO;AACvD,cAAOxD,QAAQ,QAAf;AACA,OAF2B,CAA5B;AAGA,aAAKnB,KAAL,CAAWC,OAAX,CAAmB4B,IAAnB,CAAwB;AACvBY,aAAM,MADiB;AAEvBrB,cAAO;AAFgB,OAAxB;AAIA,UAAIT,UAAU2E,SAASK,OAAT,CAAiBlC,KAAjB,CAAuB,GAAvB,CAAd;AACA,UAAG,CAAC9C,OAAD,IAAYA,QAAQ,CAAR,MAAe,CAA9B,EAAiC;AAChC,WAAIiF,aAAa,OAAKd,UAAL,CAAgBe,iBAAhB,CAAkCtF,OAAlC,EAA2CC,MAA3C,CAAjB;AACA,cAAKF,MAAL,CAAYK,OAAZ,GAAsB,CAACiF,UAAD,CAAtB;AACA,OAHD,MAGO;AACN,cAAKtF,MAAL,CAAYK,OAAZ,GAAsBA,OAAtB;AACA;AACD,MAxBD,MAwBO;AACN,UAAId,cAAc,EAAlB;AACA8B,QAAEC,IAAF,CAAOuD,KAAKI,SAAL,CAAeD,QAAtB,EAAgC,oBAAY;AAC3CzF,mBAAYgC,IAAZ,CAAiByD,SAASlB,MAA1B;AACA,OAFD;AAGA,aAAKvE,WAAL,GAAmBA,WAAnB;AACA;AACD;AACD,IAtCD;AAuCA;;;;EAlS8CiG,c;;AAqShDtG,2BAA2BuG,WAA3B,GAAyC,4BAAzC","file":"query_ctrl.js","sourcesContent":["import { QueryCtrl } from \"app/plugins/sdk\";\nimport \"./css/query-editor.css!\";\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n\tconstructor($scope, $injector) {\n\n\t\tsuper($scope, $injector);\n\t\tthis.scope = $scope;\n\t\tthis.project_list = this.project_list || [];\n\t\tthis.metric_list = this.metric_list || [];\n\t\tthis.metric_name_list = this.metric_name_list || [];\n\t\tthis.fieldName = this.fieldName || '';\n\t\tthis.panel.columns = this.panel.columns || [];\n\t\tthis.dimensionValues = this.dimensionValues || [];\n\t\tthis.oldDimensionKeys = [];\n\n\t\tthis.init = function() {\n\t\t\tthis.ListProjectDetail();\n\t\t\tthis.target.project = this.target.project || '';\n\t\t\tthis.target.metric = this.target.metric || '';\n\t\t\tthis.target.fieldNames = this.target.fieldNames || [];\n\t\t\tthis.target.selectedFieldNames = this.target.selectedFieldNames || [];\n\t\t\tthis.target.periods = this.target.periods || ['60'];\n\t\t\tthis.target.period = this.target.period || '';\n\t\t\tthis.target.dimensions = this.target.dimensions || [];\n\t\t\tthis.target.dimKVs = this.target.dimKVs || [];\n\t\t\tthis.target.dimensionKeys = this.target.dimensionKeys || [];\n\t\t};\n\t\tthis.init();\n\n\t\tthis.projectChanged = function() {\n\t\t\tif(!this.checkProject()) {\n\t\t\t\tthis.panel.title = '';\n\t\t\t\tthis.target.metric = '';\n\t\t\t\tthis.metric_list = [];\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.period = '';\n\t\t\t\tthis.target.periods = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: this.target.dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.ListMetricDetail(this.target.project, \"\");\n\t\t};\n\n\t\tthis.metricChanged = function() {\n\t\t\tif(!this.checkMetric()) {\n\t\t\t\tthis.panel.title = '';\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.period = '';\n\t\t\t\tthis.target.periods = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: this.target.dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.ListMetricDetail(this.target.project, \"\");\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.ListMetricDetail(this.target.project, this.target.metric);\n\t\t\t//修改图表标题\n\t\t\tif(!this.metric_name_list || this.metric_name_list.length === 0) {\n\t\t\t\tvar metrics = [];\n\t\t\t\t_.each(this.metric_list, metric => {\n\t\t\t\t\tmetrics.push(metric);\n\t\t\t\t});\n\t\t\t\tthis.metric_name_list = _.uniq(metrics);\n\t\t\t}\n\t\t\tvar panelTitle = this.panel.title;\n\t\t\tif(!panelTitle || panelTitle === '' || panelTitle === 'Panel Title' ||\n\t\t\t\t_.includes(this.metric_name_list, this.panel.title)) {\n\t\t\t\tthis.panel.title = this.target.metric;\n\t\t\t}\n\n\t\t\tthis.panel.columns = [];\n\t\t};\n\n\t\tthis.ensureDimension = function() {\n\t\t\tif(!this.checkProject()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar dimensionKeys = this.target.dimensionKeys;\n\t\t\tif(dimensionKeys.length !== 0) {\n\t\t\t\t_.each(dimensionKeys, dimensionKey => {\n\t\t\t\t\tthis.getDimensionValues(dimensionKey);\n\t\t\t\t});\n\t\t\t}\n\t\t\tif(!_.isEqual(dimensionKeys, this.oldDimensionKeys)) {\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.oldDimensionKeys = dimensionKeys;\n\t\t\t}\n\t\t\tthis.onChangeInternal();\n\t\t};\n\n\t\tthis.fieldNameChanged = function(fieldName) {\n\t\t\tif(!fieldName || !_.includes(this.target.fieldNames, fieldName)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar oldList = angular.copy(this.target.selectedFieldNames);\n\t\t\toldList.push(fieldName);\n\t\t\tthis.target.selectedFieldNames = _.uniq(oldList);\n\t\t\tthis.onChangeInternal();\n\t\t\tthis.panel.columns.push({\n\t\t\t\ttext: fieldName,\n\t\t\t\tvalue: fieldName\n\t\t\t});\n\t\t\tthis.panel.columns = _.uniqBy(this.panel.columns, \"text\");\n\t\t\tthis.fieldName = '';\n\t\t};\n\n\t\tthis.removeSelectedField = function($event, feild) {\n\t\t\tthis.target.selectedFieldNames = _.without(this.target.selectedFieldNames, feild);\n\t\t\t_.remove(this.panel.columns, {\n\t\t\t\ttext: feild,\n\t\t\t\tvalue: feild\n\t\t\t});\n\t\t\tthis.onChangeInternal();\n\t\t};\n\n\t\tthis.onTargetBlur = function(key, index) {\n\t\t\t//判断下标合法性\n\t\t\tvar len = this.target.dimensionKeys.length;\n\t\t\tif(index >= len) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//截除下级dimension信息\n\t\t\tvar start = index + 1;\n\t\t\tvar end = len - index;\n\t\t\tthis.target.dimKVs.splice(start, end);\n\n\t\t\t//判断dimensionValue合法性\n\t\t\tvar dimValue = this.target.dimKVs[index].value;\n\t\t\tif(!dimValue) {\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//更新dimension键值列表\n\t\t\tthis.target.dimensions = [];\n\t\t\t_.each(this.target.dimKVs, dimKV => {\n\t\t\t\tthis.target.dimensions.push(dimKV);\n\t\t\t});\n\n\t\t\t//表格类型的时序数据title添加dimension信息\n\t\t\tif(this.panel.type === 'table') {\n\t\t\t\tif(this.metric_name_list.length === 0) {\n\t\t\t\t\tthis.ListProjectDetail();\n\t\t\t\t\tthis.ListMetricDetail();\n\t\t\t\t}\n\t\t\t\t//没有指定title才修改\n\t\t\t\tif(!this.panel.title ||\n\t\t\t\t\tthis.panel.title === '' ||\n\t\t\t\t\tthis.panel.title === 'Panel Title' ||\n\t\t\t\t\t_.includes(this.metric_name_list, this.panel.title) ||\n\t\t\t\t\t_.includes(this.metric_name_list, this.panel.title.split(\"_\")[0])) {\n\t\t\t\t\tthis.panel.title = this.target.metric;\n\t\t\t\t\t_.each(this.target.dimensions, dimension => {\n\t\t\t\t\t\tthis.panel.title += ('_' + dimension.value);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.onChangeInternal();\n\n\t\t\t//判断dimensionKey是否重复\n\t\t\tvar dimKs = [];\n\t\t\t_.each(this.target.dimKVs, kv => {\n\t\t\t\tdimKs.push(kv.key);\n\t\t\t});\n\t\t\tdimKs = _.uniq(dimKs);\n\t\t\tvar nextKey = this.target.dimensionKeys[index + 1];\n\t\t\tif(!nextKey || _.includes(dimKs, nextKey)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//将新键值推送入dimKVs\n\t\t\tthis.target.dimKVs.push({\n\t\t\t\tkey: nextKey,\n\t\t\t\tvalue: ''\n\t\t\t});\n\n\t\t\tthis.dimensionValues = [];\n\t\t};\n\t}\n\n\tonChangeInternal() {\n\t\tif(this.target.selectedFieldNames.length > 0 &&\n\t\t\tthis.target.project && this.target.metric) {\n\t\t\tthis.panelCtrl.refresh(); // Asks the panel to refresh data.\n\t\t}\n\t}\n\n\tcheckProject() {\n\t\treturn this.project_list.length > 0 &&\n\t\t\tthis.target.project &&\n\t\t\t_.includes(this.project_list, this.target.project);\n\t}\n\n\tcheckMetric() {\n\t\treturn this.metric_list.length > 0 &&\n\t\t\tthis.target.metric &&\n\t\t\t_.includes(this.metric_list, this.target.metric);\n\t}\n\n\tgetDimensionValues(nextKey) {\n\t\tif(!nextKey || !this.target.project || this.target.project === '' || !this.target.metric || this.target.metric === '') {\n\t\t\treturn;\n\t\t}\n\t\tvar dimKeyIndex = _.indexOf(this.target.dimensionKeys, nextKey);\n\t\tif(dimKeyIndex >= 1 && this.target.dimensionKeys[dimKeyIndex - 1].value === 'no result') {\n\t\t\treturn;\n\t\t}\n\t\tvar query = {};\n\t\tquery.Project = this.target.project;\n\t\tquery.Metric = this.target.metric;\n\t\tquery.Period = this.target.period;\n\t\tvar now = new Date();\n\t\tquery.StartTime = now.getTime() - 1000 * 60 * 60;\n\t\tquery.EndTime = now.getTime();\n\t\tquery.Dimensions = [];\n\t\tquery.Dimensions = _.slice(this.target.dimensions, 0, dimKeyIndex);\n\t\tquery.NextKey = nextKey;\n\n\t\tthis.datasource.listDimensionValues(query).then(result => {\n\t\t\tvar dimensionValues = [];\n\t\t\tvar dimData = result.data;\n\t\t\tif(!dimData || dimData.length === 0) {\n\t\t\t\tdimensionValues.push('no result');\n\t\t\t} else {\n\t\t\t\tdimensionValues = dimData;\n\t\t\t}\n\t\t\tthis.dimensionValues = dimensionValues;\n\t\t});\n\t}\n\n\tListProjectDetail() {\n\t\tthis.datasource.ListProjectDetail().then(result => {\n\t\t\tthis.project_list = result;\n\t\t});\n\t}\n\n\tListMetricDetail(project, metric) {\n\t\tthis.datasource.ListMetricDetail({\n\t\t\tProject: project,\n\t\t\tMetric: metric\n\t\t}).then(result => {\n\t\t\tvar data = result.data;\n\t\t\tif(data.ErrorCode === 200 && data.Success === true) {\n\t\t\t\tif(metric != \"\") {\n\t\t\t\t\tvar Resource = data.Resources.Resource[0];\n\t\t\t\t\tthis.target.fieldNames = Resource.Statistics.split(\",\");\n\t\t\t\t\tthis.target.selectedFieldNames = _.intersection(this.target.selectedFieldNames, this.target.fieldNames);\n\t\t\t\t\tvar Dimensions = [];\n\t\t\t\t\tif(Resource.Dimensions.indexOf(\",\") === -1) {\n\t\t\t\t\t\tDimensions.push(Resource.Dimensions)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tDimensions = Resource.Dimensions.split(\",\");\n\t\t\t\t\t};\n\t\t\t\t\tthis.target.dimensionKeys = _.filter(Dimensions, key => {\n\t\t\t\t\t\treturn key !== 'userId';\n\t\t\t\t\t});\n\t\t\t\t\tthis.panel.columns.push({\n\t\t\t\t\t\ttext: 'Time',\n\t\t\t\t\t\tvalue: 'Time'\n\t\t\t\t\t});\n\t\t\t\t\tvar periods = Resource.Periods.split(\",\");\n\t\t\t\t\tif(!periods || periods[0] === 0) {\n\t\t\t\t\t\tvar tempPeriod = this.datasource.loadDefaultPeroid(project, metric);\n\t\t\t\t\t\tthis.target.periods = [tempPeriod];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.target.periods = periods;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tvar metric_list = [];\n\t\t\t\t\t_.each(data.Resources.Resource, Resource => {\n\t\t\t\t\t\tmetric_list.push(Resource.Metric);\n\t\t\t\t\t});\n\t\t\t\t\tthis.metric_list = metric_list;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';"]}