{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","GenericDatasourceQueryCtrl","$scope","$injector","scope","project_list","metric_list","metric_name_list","fieldName","panel","columns","dimensionValues","oldDimensionKeys","init","ListProjectDetail","target","project","metric","fieldNames","selectedFieldNames","periods","period","dimensions","dimKVs","dimensionKeys","projectChanged","checkProject","title","key","value","onChangeInternal","ListMetricDetail","metricChanged","checkMetric","length","metrics","_","each","push","uniq","panelTitle","includes","ensureDimension","getDimensionValues","dimensionKey","isEqual","fieldNameChanged","oldList","angular","copy","text","uniqBy","removeSelectedField","$event","feild","without","remove","onTargetBlur","index","len","start","end","splice","dimValue","dimKV","type","split","dimension","dimKs","kv","nextKey","panelCtrl","refresh","dimKeyIndex","indexOf","query","Project","Metric","Period","now","Date","StartTime","getTime","EndTime","Dimensions","slice","NextKey","datasource","listDimensionValues","then","dimData","result","data","ErrorCode","Success","Resource","Resources","Statistics","intersection","filter","Periods","tempPeriod","loadDefaultPeroid","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,Y,kBAAAA,S;;;;;;;;;;;;;;;;;;;;;yCAGIC,0B;;;AAEZ,wCAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA,yJAExBD,MAFwB,EAEhBC,SAFgB;;AAG9B,WAAKC,KAAL,GAAaF,MAAb;AACA,WAAKG,YAAL,GAAoB,MAAKA,YAAL,IAAqB,EAAzC;AACA,WAAKC,WAAL,GAAmB,MAAKA,WAAL,IAAoB,EAAvC;AACA,WAAKC,gBAAL,GAAwB,MAAKA,gBAAL,IAAyB,EAAjD;AACA,WAAKC,SAAL,GAAiB,MAAKA,SAAL,IAAkB,EAAnC;AACA,WAAKC,KAAL,CAAWC,OAAX,GAAqB,MAAKD,KAAL,CAAWC,OAAX,IAAsB,EAA3C;AACA,WAAKC,eAAL,GAAuB,MAAKA,eAAL,IAAwB,EAA/C;AACA,WAAKC,gBAAL,GAAwB,EAAxB;;AAEA,WAAKC,IAAL,GAAY,YAAW;AACtB,WAAKC,iBAAL;AACA,WAAKC,MAAL,CAAYC,OAAZ,GAAsB,KAAKD,MAAL,CAAYC,OAAZ,IAAuB,EAA7C;AACA,WAAKD,MAAL,CAAYE,MAAZ,GAAqB,KAAKF,MAAL,CAAYE,MAAZ,IAAsB,EAA3C;AACA,WAAKF,MAAL,CAAYG,UAAZ,GAAyB,KAAKH,MAAL,CAAYG,UAAZ,IAA0B,EAAnD;AACA,WAAKH,MAAL,CAAYI,kBAAZ,GAAiC,KAAKJ,MAAL,CAAYI,kBAAZ,IAAkC,EAAnE;AACA,WAAKJ,MAAL,CAAYK,OAAZ,GAAsB,KAAKL,MAAL,CAAYK,OAAZ,IAAuB,CAAC,IAAD,CAA7C;AACA,WAAKL,MAAL,CAAYM,MAAZ,GAAqB,KAAKN,MAAL,CAAYM,MAAZ,IAAsB,EAA3C;AACA,WAAKN,MAAL,CAAYO,UAAZ,GAAyB,KAAKP,MAAL,CAAYO,UAAZ,IAA0B,EAAnD;AACA,WAAKP,MAAL,CAAYQ,MAAZ,GAAqB,KAAKR,MAAL,CAAYQ,MAAZ,IAAsB,EAA3C;AACA,WAAKR,MAAL,CAAYS,aAAZ,GAA4B,KAAKT,MAAL,CAAYS,aAAZ,IAA6B,EAAzD;AACA,MAXD;AAYA,WAAKX,IAAL;;AAEA,WAAKY,cAAL,GAAsB,YAAW;AAChC,UAAG,CAAC,KAAKC,YAAL,EAAJ,EAAyB;AACxB,YAAKjB,KAAL,CAAWkB,KAAX,GAAmB,EAAnB;AACA,YAAKZ,MAAL,CAAYE,MAAZ,GAAqB,EAArB;AACA,YAAKX,WAAL,GAAmB,EAAnB;AACA,YAAKS,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,YAAKJ,MAAL,CAAYM,MAAZ,GAAqB,EAArB;AACA,YAAKN,MAAL,CAAYK,OAAZ,GAAsB,EAAtB;AACA,YAAKL,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,YAAKP,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,aAAK,KAAKb,MAAL,CAAYS,aAAZ,CAA0B,CAA1B,CADgB;AAErBK,eAAO;AAFc,QAAD,CAArB;AAIA,YAAKC,gBAAL;AACA;AACA;AACD,WAAKC,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,EAA3C;AACA,MAjBD;;AAmBA,WAAKgB,aAAL,GAAqB,YAAW;AAC/B,UAAG,CAAC,KAAKC,WAAL,EAAJ,EAAwB;AACvB,YAAKxB,KAAL,CAAWkB,KAAX,GAAmB,EAAnB;AACA,YAAKZ,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,YAAKJ,MAAL,CAAYM,MAAZ,GAAqB,EAArB;AACA,YAAKN,MAAL,CAAYK,OAAZ,GAAsB,EAAtB;AACA,YAAKL,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,YAAKP,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,aAAK,KAAKb,MAAL,CAAYS,aAAZ,CAA0B,CAA1B,CADgB;AAErBK,eAAO;AAFc,QAAD,CAArB;AAIA,YAAKE,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,EAA3C;AACA,YAAKc,gBAAL;AACA;AACA;AACD,WAAKC,gBAAL,CAAsB,KAAKhB,MAAL,CAAYC,OAAlC,EAA2C,KAAKD,MAAL,CAAYE,MAAvD;AACA;AACA,UAAG,CAAC,KAAKV,gBAAN,IAA0B,KAAKA,gBAAL,CAAsB2B,MAAtB,KAAiC,CAA9D,EAAiE;AAChE,WAAIC,UAAU,EAAd;AACAC,SAAEC,IAAF,CAAO,KAAK/B,WAAZ,EAAyB,kBAAU;AAClC6B,gBAAQG,IAAR,CAAarB,MAAb;AACA,QAFD;AAGA,YAAKV,gBAAL,GAAwB6B,EAAEG,IAAF,CAAOJ,OAAP,CAAxB;AACA;AACD,UAAIK,aAAa,KAAK/B,KAAL,CAAWkB,KAA5B;AACA,UAAG,CAACa,UAAD,IAAeA,eAAe,EAA9B,IAAoCA,eAAe,aAAnD,IACFJ,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAA7C,CADD,EACsD;AACrD,YAAKlB,KAAL,CAAWkB,KAAX,GAAmB,KAAKZ,MAAL,CAAYE,MAA/B;AACA;;AAED,WAAKR,KAAL,CAAWC,OAAX,GAAqB,EAArB;AACA,MA/BD;;AAiCA,WAAKgC,eAAL,GAAuB,YAAW;AAAA;;AACjC,UAAG,CAAC,KAAKhB,YAAL,EAAJ,EAAyB;AACxB;AACA;AACD,UAAIF,gBAAgB,KAAKT,MAAL,CAAYS,aAAhC;AACA,UAAGA,cAAcU,MAAd,KAAyB,CAA5B,EAA+B;AAC9BE,SAAEC,IAAF,CAAOb,aAAP,EAAsB,wBAAgB;AACrC,eAAKmB,kBAAL,CAAwBC,YAAxB;AACA,QAFD;AAGA;AACD,UAAG,CAACR,EAAES,OAAF,CAAUrB,aAAV,EAAyB,KAAKZ,gBAA9B,CAAJ,EAAqD;AACpD,YAAKG,MAAL,CAAYQ,MAAZ,GAAqB,CAAC;AACrBK,aAAKJ,cAAc,CAAd,CADgB;AAErBK,eAAO;AAFc,QAAD,CAArB;AAIA,YAAKd,MAAL,CAAYI,kBAAZ,GAAiC,EAAjC;AACA,YAAKJ,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACA,YAAKV,gBAAL,GAAwBY,aAAxB;AACA;AACD,WAAKM,gBAAL;AACA,MApBD;;AAsBA,WAAKgB,gBAAL,GAAwB,UAAStC,SAAT,EAAoB;AAC3C,UAAG,CAACA,SAAD,IAAc,CAAC4B,EAAEK,QAAF,CAAW,KAAK1B,MAAL,CAAYG,UAAvB,EAAmCV,SAAnC,CAAlB,EAAiE;AAChE;AACA;AACD,UAAIuC,UAAUC,QAAQC,IAAR,CAAa,KAAKlC,MAAL,CAAYI,kBAAzB,CAAd;AACA4B,cAAQT,IAAR,CAAa9B,SAAb;AACA,WAAKO,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAEG,IAAF,CAAOQ,OAAP,CAAjC;AACA,WAAKjB,gBAAL;AACA,WAAKrB,KAAL,CAAWC,OAAX,CAAmB4B,IAAnB,CAAwB;AACvBY,aAAM1C,SADiB;AAEvBqB,cAAOrB;AAFgB,OAAxB;AAIA,WAAKC,KAAL,CAAWC,OAAX,GAAqB0B,EAAEe,MAAF,CAAS,KAAK1C,KAAL,CAAWC,OAApB,EAA6B,MAA7B,CAArB;AACA,WAAKF,SAAL,GAAiB,EAAjB;AACA,MAdD;;AAgBA,WAAK4C,mBAAL,GAA2B,UAASC,MAAT,EAAiBC,KAAjB,EAAwB;AAClD,WAAKvC,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAEmB,OAAF,CAAU,KAAKxC,MAAL,CAAYI,kBAAtB,EAA0CmC,KAA1C,CAAjC;AACAlB,QAAEoB,MAAF,CAAS,KAAK/C,KAAL,CAAWC,OAApB,EAA6B;AAC5BwC,aAAMI,KADsB;AAE5BzB,cAAOyB;AAFqB,OAA7B;AAIA,WAAKxB,gBAAL;AACA,MAPD;;AASA,WAAK2B,YAAL,GAAoB,UAAS7B,GAAT,EAAc8B,KAAd,EAAqB;AAAA;;AACxC;AACA,UAAIC,MAAM,KAAK5C,MAAL,CAAYS,aAAZ,CAA0BU,MAApC;AACA,UAAGwB,SAASC,GAAZ,EAAiB;AAChB;AACA;;AAED;AACA,UAAIC,QAAQF,QAAQ,CAApB;AACA,UAAIG,MAAMF,MAAMD,KAAhB;AACA,WAAK3C,MAAL,CAAYQ,MAAZ,CAAmBuC,MAAnB,CAA0BF,KAA1B,EAAiCC,GAAjC;;AAEA;AACA,UAAIE,WAAW,KAAKhD,MAAL,CAAYQ,MAAZ,CAAmBmC,KAAnB,EAA0B7B,KAAzC;AACA,UAAG,CAACkC,QAAJ,EAAc;AACb,YAAKjC,gBAAL;AACA;AACA;;AAED;AACA,WAAKf,MAAL,CAAYO,UAAZ,GAAyB,EAAzB;AACAc,QAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYQ,MAAnB,EAA2B,iBAAS;AACnC,cAAKR,MAAL,CAAYO,UAAZ,CAAuBgB,IAAvB,CAA4B0B,KAA5B;AACA,OAFD;;AAIA;AACA,UAAG,KAAKvD,KAAL,CAAWwD,IAAX,KAAoB,OAAvB,EAAgC;AAC/B,WAAG,KAAK1D,gBAAL,CAAsB2B,MAAtB,KAAiC,CAApC,EAAuC;AACtC,aAAKpB,iBAAL;AACA,aAAKiB,gBAAL;AACA;AACD;AACA,WAAG,CAAC,KAAKtB,KAAL,CAAWkB,KAAZ,IACF,KAAKlB,KAAL,CAAWkB,KAAX,KAAqB,EADnB,IAEF,KAAKlB,KAAL,CAAWkB,KAAX,KAAqB,aAFnB,IAGFS,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAA7C,CAHE,IAIFS,EAAEK,QAAF,CAAW,KAAKlC,gBAAhB,EAAkC,KAAKE,KAAL,CAAWkB,KAAX,CAAiBuC,KAAjB,CAAuB,GAAvB,EAA4B,CAA5B,CAAlC,CAJD,EAIoE;AACnE,aAAKzD,KAAL,CAAWkB,KAAX,GAAmB,KAAKZ,MAAL,CAAYE,MAA/B;AACAmB,UAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYO,UAAnB,EAA+B,qBAAa;AAC3C,gBAAKb,KAAL,CAAWkB,KAAX,IAAqB,MAAMwC,UAAUtC,KAArC;AACA,SAFD;AAGA;AACD;;AAED,WAAKC,gBAAL;;AAEA;AACA,UAAIsC,QAAQ,EAAZ;AACAhC,QAAEC,IAAF,CAAO,KAAKtB,MAAL,CAAYQ,MAAnB,EAA2B,cAAM;AAChC6C,aAAM9B,IAAN,CAAW+B,GAAGzC,GAAd;AACA,OAFD;AAGAwC,cAAQhC,EAAEG,IAAF,CAAO6B,KAAP,CAAR;AACA,UAAIE,UAAU,KAAKvD,MAAL,CAAYS,aAAZ,CAA0BkC,QAAQ,CAAlC,CAAd;AACA,UAAG,CAACY,OAAD,IAAYlC,EAAEK,QAAF,CAAW2B,KAAX,EAAkBE,OAAlB,CAAf,EAA2C;AAC1C;AACA;;AAED;AACA,WAAKvD,MAAL,CAAYQ,MAAZ,CAAmBe,IAAnB,CAAwB;AACvBV,YAAK0C,OADkB;AAEvBzC,cAAO;AAFgB,OAAxB;;AAKA,WAAKlB,eAAL,GAAuB,EAAvB;AACA,MAhED;AA7H8B;AA8L9B;;;;wCAEkB;AAClB,UAAG,KAAKI,MAAL,CAAYI,kBAAZ,CAA+Be,MAA/B,GAAwC,CAAxC,IACF,KAAKnB,MAAL,CAAYC,OADV,IACqB,KAAKD,MAAL,CAAYE,MADpC,EAC4C;AAC3C,YAAKsD,SAAL,CAAeC,OAAf,GAD2C,CACjB;AAC1B;AACD;;;oCAEc;AACd,aAAO,KAAKnE,YAAL,CAAkB6B,MAAlB,GAA2B,CAA3B,IACN,KAAKnB,MAAL,CAAYC,OADN,IAENoB,EAAEK,QAAF,CAAW,KAAKpC,YAAhB,EAA8B,KAAKU,MAAL,CAAYC,OAA1C,CAFD;AAGA;;;mCAEa;AACb,aAAO,KAAKV,WAAL,CAAiB4B,MAAjB,GAA0B,CAA1B,IACN,KAAKnB,MAAL,CAAYE,MADN,IAENmB,EAAEK,QAAF,CAAW,KAAKnC,WAAhB,EAA6B,KAAKS,MAAL,CAAYE,MAAzC,CAFD;AAGA;;;wCAEkBqD,O,EAAS;AAAA;;AAC3B,UAAG,CAACA,OAAD,IAAY,CAAC,KAAKvD,MAAL,CAAYC,OAAzB,IAAoC,KAAKD,MAAL,CAAYC,OAAZ,KAAwB,EAA5D,IAAkE,CAAC,KAAKD,MAAL,CAAYE,MAA/E,IAAyF,KAAKF,MAAL,CAAYE,MAAZ,KAAuB,EAAnH,EAAuH;AACtH;AACA;AACD,UAAIwD,cAAcrC,EAAEsC,OAAF,CAAU,KAAK3D,MAAL,CAAYS,aAAtB,EAAqC8C,OAArC,CAAlB;AACA,UAAGG,eAAe,CAAf,IAAoB,KAAK1D,MAAL,CAAYS,aAAZ,CAA0BiD,cAAc,CAAxC,EAA2C5C,KAA3C,KAAqD,WAA5E,EAAyF;AACxF;AACA;AACD,UAAI8C,QAAQ,EAAZ;AACAA,YAAMC,OAAN,GAAgB,KAAK7D,MAAL,CAAYC,OAA5B;AACA2D,YAAME,MAAN,GAAe,KAAK9D,MAAL,CAAYE,MAA3B;AACA0D,YAAMG,MAAN,GAAe,KAAK/D,MAAL,CAAYM,MAA3B;AACA,UAAI0D,MAAM,IAAIC,IAAJ,EAAV;AACAL,YAAMM,SAAN,GAAkBF,IAAIG,OAAJ,KAAgB,OAAO,EAAP,GAAY,EAA9C;AACAP,YAAMQ,OAAN,GAAgBJ,IAAIG,OAAJ,EAAhB;AACAP,YAAMS,UAAN,GAAmB,EAAnB;AACAT,YAAMS,UAAN,GAAmBhD,EAAEiD,KAAF,CAAQ,KAAKtE,MAAL,CAAYO,UAApB,EAAgC,CAAhC,EAAmCmD,WAAnC,CAAnB;AACAE,YAAMW,OAAN,GAAgBhB,OAAhB;;AAEA,WAAKiB,UAAL,CAAgBC,mBAAhB,CAAoCb,KAApC,EAA2Cc,IAA3C,CAAgD,kBAAU;AACzD,WAAI9E,kBAAkB,EAAtB;AACA,WAAI+E,UAAUC,OAAOC,IAArB;AACA,WAAG,CAACF,OAAD,IAAYA,QAAQxD,MAAR,KAAmB,CAAlC,EAAqC;AACpCvB,wBAAgB2B,IAAhB,CAAqB,WAArB;AACA,QAFD,MAEO;AACN3B,0BAAkB+E,OAAlB;AACA;AACD,cAAK/E,eAAL,GAAuBA,eAAvB;AACA,OATD;AAUA;;;yCAEmB;AAAA;;AACnB,WAAK4E,UAAL,CAAgBzE,iBAAhB,GAAoC2E,IAApC,CAAyC,kBAAU;AAClD,cAAKpF,YAAL,GAAoBsF,MAApB;AACA,OAFD;AAGA;;;sCAEgB3E,O,EAASC,M,EAAQ;AAAA;;AACjC,WAAKsE,UAAL,CAAgBxD,gBAAhB,CAAiC;AAChC6C,gBAAS5D,OADuB;AAEhC6D,eAAQ5D;AAFwB,OAAjC,EAGGwE,IAHH,CAGQ,kBAAU;AACjB,WAAIG,OAAOD,OAAOC,IAAlB;AACA,WAAGA,KAAKC,SAAL,KAAmB,GAAnB,IAA0BD,KAAKE,OAAL,KAAiB,IAA9C,EAAoD;AACnD,YAAG7E,UAAU,EAAb,EAAiB;AAChB,aAAI8E,WAAWH,KAAKI,SAAL,CAAeD,QAAf,CAAwB,CAAxB,CAAf;AACA,gBAAKhF,MAAL,CAAYG,UAAZ,GAAyB6E,SAASE,UAAT,CAAoB/B,KAApB,CAA0B,GAA1B,CAAzB;AACA,gBAAKnD,MAAL,CAAYI,kBAAZ,GAAiCiB,EAAE8D,YAAF,CAAe,OAAKnF,MAAL,CAAYI,kBAA3B,EAA+C,OAAKJ,MAAL,CAAYG,UAA3D,CAAjC;AACA,aAAIkE,aAAa,EAAjB;AACA,aAAGW,SAASX,UAAT,CAAoBV,OAApB,CAA4B,GAA5B,MAAqC,CAAC,CAAzC,EAA4C;AAC3CU,qBAAW9C,IAAX,CAAgByD,SAASX,UAAzB;AACA,UAFD,MAEO;AACNA,uBAAaW,SAASX,UAAT,CAAoBlB,KAApB,CAA0B,GAA1B,CAAb;AACA;AACD,gBAAKnD,MAAL,CAAYS,aAAZ,GAA4BY,EAAE+D,MAAF,CAASf,UAAT,EAAqB,eAAO;AACvD,iBAAOxD,QAAQ,QAAf;AACA,UAF2B,CAA5B;AAGA,gBAAKnB,KAAL,CAAWC,OAAX,CAAmB4B,IAAnB,CAAwB;AACvBY,gBAAM,MADiB;AAEvBrB,iBAAO;AAFgB,UAAxB;AAIA,aAAIT,UAAU2E,SAASK,OAAT,CAAiBlC,KAAjB,CAAuB,GAAvB,CAAd;AACA,aAAG,CAAC9C,OAAD,IAAYA,QAAQ,CAAR,MAAe,CAA9B,EAAiC;AAChC,cAAIiF,aAAa,OAAKd,UAAL,CAAgBe,iBAAhB,CAAkCtF,OAAlC,EAA2CC,MAA3C,CAAjB;AACA,iBAAKF,MAAL,CAAYK,OAAZ,GAAsB,CAACiF,UAAD,CAAtB;AACA,UAHD,MAGO;AACN,iBAAKtF,MAAL,CAAYK,OAAZ,GAAsBA,OAAtB;AACA;AACD,SAxBD,MAwBO;AACN,aAAId,cAAc,EAAlB;AACA8B,WAAEC,IAAF,CAAOuD,KAAKI,SAAL,CAAeD,QAAtB,EAAgC,oBAAY;AAC3CzF,sBAAYgC,IAAZ,CAAiByD,SAASlB,MAA1B;AACA,UAFD;AAGA,gBAAKvE,WAAL,GAAmBA,WAAnB;AACA;AACD;AACD,OAtCD;AAuCA;;;;KAlS8CN,S;;;;AAqShDC,8BAA2BsG,WAA3B,GAAyC,4BAAzC","file":"query_ctrl.js","sourcesContent":["import { QueryCtrl } from \"app/plugins/sdk\";\nimport \"./css/query-editor.css!\";\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n\tconstructor($scope, $injector) {\n\n\t\tsuper($scope, $injector);\n\t\tthis.scope = $scope;\n\t\tthis.project_list = this.project_list || [];\n\t\tthis.metric_list = this.metric_list || [];\n\t\tthis.metric_name_list = this.metric_name_list || [];\n\t\tthis.fieldName = this.fieldName || '';\n\t\tthis.panel.columns = this.panel.columns || [];\n\t\tthis.dimensionValues = this.dimensionValues || [];\n\t\tthis.oldDimensionKeys = [];\n\n\t\tthis.init = function() {\n\t\t\tthis.ListProjectDetail();\n\t\t\tthis.target.project = this.target.project || '';\n\t\t\tthis.target.metric = this.target.metric || '';\n\t\t\tthis.target.fieldNames = this.target.fieldNames || [];\n\t\t\tthis.target.selectedFieldNames = this.target.selectedFieldNames || [];\n\t\t\tthis.target.periods = this.target.periods || ['60'];\n\t\t\tthis.target.period = this.target.period || '';\n\t\t\tthis.target.dimensions = this.target.dimensions || [];\n\t\t\tthis.target.dimKVs = this.target.dimKVs || [];\n\t\t\tthis.target.dimensionKeys = this.target.dimensionKeys || [];\n\t\t};\n\t\tthis.init();\n\n\t\tthis.projectChanged = function() {\n\t\t\tif(!this.checkProject()) {\n\t\t\t\tthis.panel.title = '';\n\t\t\t\tthis.target.metric = '';\n\t\t\t\tthis.metric_list = [];\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.period = '';\n\t\t\t\tthis.target.periods = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: this.target.dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.ListMetricDetail(this.target.project, \"\");\n\t\t};\n\n\t\tthis.metricChanged = function() {\n\t\t\tif(!this.checkMetric()) {\n\t\t\t\tthis.panel.title = '';\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.period = '';\n\t\t\t\tthis.target.periods = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: this.target.dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.ListMetricDetail(this.target.project, \"\");\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.ListMetricDetail(this.target.project, this.target.metric);\n\t\t\t//修改图表标题\n\t\t\tif(!this.metric_name_list || this.metric_name_list.length === 0) {\n\t\t\t\tvar metrics = [];\n\t\t\t\t_.each(this.metric_list, metric => {\n\t\t\t\t\tmetrics.push(metric);\n\t\t\t\t});\n\t\t\t\tthis.metric_name_list = _.uniq(metrics);\n\t\t\t}\n\t\t\tvar panelTitle = this.panel.title;\n\t\t\tif(!panelTitle || panelTitle === '' || panelTitle === 'Panel Title' ||\n\t\t\t\t_.includes(this.metric_name_list, this.panel.title)) {\n\t\t\t\tthis.panel.title = this.target.metric;\n\t\t\t}\n\n\t\t\tthis.panel.columns = [];\n\t\t};\n\n\t\tthis.ensureDimension = function() {\n\t\t\tif(!this.checkProject()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar dimensionKeys = this.target.dimensionKeys;\n\t\t\tif(dimensionKeys.length !== 0) {\n\t\t\t\t_.each(dimensionKeys, dimensionKey => {\n\t\t\t\t\tthis.getDimensionValues(dimensionKey);\n\t\t\t\t});\n\t\t\t}\n\t\t\tif(!_.isEqual(dimensionKeys, this.oldDimensionKeys)) {\n\t\t\t\tthis.target.dimKVs = [{\n\t\t\t\t\tkey: dimensionKeys[0],\n\t\t\t\t\tvalue: ''\n\t\t\t\t}];\n\t\t\t\tthis.target.selectedFieldNames = [];\n\t\t\t\tthis.target.dimensions = [];\n\t\t\t\tthis.oldDimensionKeys = dimensionKeys;\n\t\t\t}\n\t\t\tthis.onChangeInternal();\n\t\t};\n\n\t\tthis.fieldNameChanged = function(fieldName) {\n\t\t\tif(!fieldName || !_.includes(this.target.fieldNames, fieldName)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar oldList = angular.copy(this.target.selectedFieldNames);\n\t\t\toldList.push(fieldName);\n\t\t\tthis.target.selectedFieldNames = _.uniq(oldList);\n\t\t\tthis.onChangeInternal();\n\t\t\tthis.panel.columns.push({\n\t\t\t\ttext: fieldName,\n\t\t\t\tvalue: fieldName\n\t\t\t});\n\t\t\tthis.panel.columns = _.uniqBy(this.panel.columns, \"text\");\n\t\t\tthis.fieldName = '';\n\t\t};\n\n\t\tthis.removeSelectedField = function($event, feild) {\n\t\t\tthis.target.selectedFieldNames = _.without(this.target.selectedFieldNames, feild);\n\t\t\t_.remove(this.panel.columns, {\n\t\t\t\ttext: feild,\n\t\t\t\tvalue: feild\n\t\t\t});\n\t\t\tthis.onChangeInternal();\n\t\t};\n\n\t\tthis.onTargetBlur = function(key, index) {\n\t\t\t//判断下标合法性\n\t\t\tvar len = this.target.dimensionKeys.length;\n\t\t\tif(index >= len) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//截除下级dimension信息\n\t\t\tvar start = index + 1;\n\t\t\tvar end = len - index;\n\t\t\tthis.target.dimKVs.splice(start, end);\n\n\t\t\t//判断dimensionValue合法性\n\t\t\tvar dimValue = this.target.dimKVs[index].value;\n\t\t\tif(!dimValue) {\n\t\t\t\tthis.onChangeInternal();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//更新dimension键值列表\n\t\t\tthis.target.dimensions = [];\n\t\t\t_.each(this.target.dimKVs, dimKV => {\n\t\t\t\tthis.target.dimensions.push(dimKV);\n\t\t\t});\n\n\t\t\t//表格类型的时序数据title添加dimension信息\n\t\t\tif(this.panel.type === 'table') {\n\t\t\t\tif(this.metric_name_list.length === 0) {\n\t\t\t\t\tthis.ListProjectDetail();\n\t\t\t\t\tthis.ListMetricDetail();\n\t\t\t\t}\n\t\t\t\t//没有指定title才修改\n\t\t\t\tif(!this.panel.title ||\n\t\t\t\t\tthis.panel.title === '' ||\n\t\t\t\t\tthis.panel.title === 'Panel Title' ||\n\t\t\t\t\t_.includes(this.metric_name_list, this.panel.title) ||\n\t\t\t\t\t_.includes(this.metric_name_list, this.panel.title.split(\"_\")[0])) {\n\t\t\t\t\tthis.panel.title = this.target.metric;\n\t\t\t\t\t_.each(this.target.dimensions, dimension => {\n\t\t\t\t\t\tthis.panel.title += ('_' + dimension.value);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.onChangeInternal();\n\n\t\t\t//判断dimensionKey是否重复\n\t\t\tvar dimKs = [];\n\t\t\t_.each(this.target.dimKVs, kv => {\n\t\t\t\tdimKs.push(kv.key);\n\t\t\t});\n\t\t\tdimKs = _.uniq(dimKs);\n\t\t\tvar nextKey = this.target.dimensionKeys[index + 1];\n\t\t\tif(!nextKey || _.includes(dimKs, nextKey)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//将新键值推送入dimKVs\n\t\t\tthis.target.dimKVs.push({\n\t\t\t\tkey: nextKey,\n\t\t\t\tvalue: ''\n\t\t\t});\n\n\t\t\tthis.dimensionValues = [];\n\t\t};\n\t}\n\n\tonChangeInternal() {\n\t\tif(this.target.selectedFieldNames.length > 0 &&\n\t\t\tthis.target.project && this.target.metric) {\n\t\t\tthis.panelCtrl.refresh(); // Asks the panel to refresh data.\n\t\t}\n\t}\n\n\tcheckProject() {\n\t\treturn this.project_list.length > 0 &&\n\t\t\tthis.target.project &&\n\t\t\t_.includes(this.project_list, this.target.project);\n\t}\n\n\tcheckMetric() {\n\t\treturn this.metric_list.length > 0 &&\n\t\t\tthis.target.metric &&\n\t\t\t_.includes(this.metric_list, this.target.metric);\n\t}\n\n\tgetDimensionValues(nextKey) {\n\t\tif(!nextKey || !this.target.project || this.target.project === '' || !this.target.metric || this.target.metric === '') {\n\t\t\treturn;\n\t\t}\n\t\tvar dimKeyIndex = _.indexOf(this.target.dimensionKeys, nextKey);\n\t\tif(dimKeyIndex >= 1 && this.target.dimensionKeys[dimKeyIndex - 1].value === 'no result') {\n\t\t\treturn;\n\t\t}\n\t\tvar query = {};\n\t\tquery.Project = this.target.project;\n\t\tquery.Metric = this.target.metric;\n\t\tquery.Period = this.target.period;\n\t\tvar now = new Date();\n\t\tquery.StartTime = now.getTime() - 1000 * 60 * 60;\n\t\tquery.EndTime = now.getTime();\n\t\tquery.Dimensions = [];\n\t\tquery.Dimensions = _.slice(this.target.dimensions, 0, dimKeyIndex);\n\t\tquery.NextKey = nextKey;\n\n\t\tthis.datasource.listDimensionValues(query).then(result => {\n\t\t\tvar dimensionValues = [];\n\t\t\tvar dimData = result.data;\n\t\t\tif(!dimData || dimData.length === 0) {\n\t\t\t\tdimensionValues.push('no result');\n\t\t\t} else {\n\t\t\t\tdimensionValues = dimData;\n\t\t\t}\n\t\t\tthis.dimensionValues = dimensionValues;\n\t\t});\n\t}\n\n\tListProjectDetail() {\n\t\tthis.datasource.ListProjectDetail().then(result => {\n\t\t\tthis.project_list = result;\n\t\t});\n\t}\n\n\tListMetricDetail(project, metric) {\n\t\tthis.datasource.ListMetricDetail({\n\t\t\tProject: project,\n\t\t\tMetric: metric\n\t\t}).then(result => {\n\t\t\tvar data = result.data;\n\t\t\tif(data.ErrorCode === 200 && data.Success === true) {\n\t\t\t\tif(metric != \"\") {\n\t\t\t\t\tvar Resource = data.Resources.Resource[0];\n\t\t\t\t\tthis.target.fieldNames = Resource.Statistics.split(\",\");\n\t\t\t\t\tthis.target.selectedFieldNames = _.intersection(this.target.selectedFieldNames, this.target.fieldNames);\n\t\t\t\t\tvar Dimensions = [];\n\t\t\t\t\tif(Resource.Dimensions.indexOf(\",\") === -1) {\n\t\t\t\t\t\tDimensions.push(Resource.Dimensions)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tDimensions = Resource.Dimensions.split(\",\");\n\t\t\t\t\t};\n\t\t\t\t\tthis.target.dimensionKeys = _.filter(Dimensions, key => {\n\t\t\t\t\t\treturn key !== 'userId';\n\t\t\t\t\t});\n\t\t\t\t\tthis.panel.columns.push({\n\t\t\t\t\t\ttext: 'Time',\n\t\t\t\t\t\tvalue: 'Time'\n\t\t\t\t\t});\n\t\t\t\t\tvar periods = Resource.Periods.split(\",\");\n\t\t\t\t\tif(!periods || periods[0] === 0) {\n\t\t\t\t\t\tvar tempPeriod = this.datasource.loadDefaultPeroid(project, metric);\n\t\t\t\t\t\tthis.target.periods = [tempPeriod];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.target.periods = periods;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tvar metric_list = [];\n\t\t\t\t\t_.each(data.Resources.Resource, Resource => {\n\t\t\t\t\t\tmetric_list.push(Resource.Metric);\n\t\t\t\t\t});\n\t\t\t\t\tthis.metric_list = metric_list;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n}\n\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';"]}