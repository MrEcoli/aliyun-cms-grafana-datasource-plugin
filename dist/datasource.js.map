{"version":3,"sources":["../src/datasource.js"],"names":["_","CmsSigner","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","default_period","acs_ecs_dashboard","acs_rds_dashboard","acs_slb_dashboard","acs_memcache","acs_ocs","acs_vpc_eip","acs_kvstore","acs_mns_new","acs_cdn","acs_ads","acs_mongodb","acs_express_connect","acs_fc","acs_nat_gateway","options","console","log","paramPattern","start","Date","range","from","getTime","end","to","queries","targets","forEach","target","project","metric","query","Project","Metric","period","loadDefaultPeroid","Period","StartTime","EndTime","dimension","each","dimensions","dim","value","key","Dimensions","JSON","stringify","keys","replace","uriEscape","param","path","method","push","buildRealUrl","isEmpty","d","defer","resolve","data","promise","allQueryPromise","map","headers","datasourceRequest","bind","all","then","allResponse","result","response","index","selectedFieldNames","resResult","datapoints","Datapoints","parse","datapoint","Datapoint","selectedFieldName","timestamp","concat","string","output","encodeURIComponent","escape","ch","charCodeAt","toString","toUpperCase","Resources","Resource","parameters","undefined","Code","dimList","NextKey","status","message","title","items","match","dimensionValues","split","i","pm","indexOf","arr","dimensionKeys","filter","j","k","now","mapToTextValue","text","isObject","signer","accessKeyId","cmsAccessKey","secretAccessKey","cmsSecretKey","addAuthorization","request"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport { CmsSigner } from \"./signer\";\n\nexport class GenericDatasource {\n\n\tconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n\t\tthis.type = instanceSettings.type;\n\t\tthis.basePath = instanceSettings.url;\n\t\tthis.name = instanceSettings.name;\n\t\tthis.jsonData = instanceSettings.jsonData;\n\t\tthis.q = $q;\n\t\tthis.backendSrv = backendSrv;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.default_period = {\n\t\t\tacs_ecs_dashboard: '60',\n\t\t\tacs_rds_dashboard: '300',\n\t\t\tacs_slb_dashboard: '60',\n\t\t\tacs_memcache: '60',\n\t\t\tacs_ocs: '60',\n\t\t\tacs_vpc_eip: '60',\n\t\t\tacs_kvstore: '60',\n\t\t\tacs_mns_new: '300',\n\t\t\tacs_cdn: '60',\n\t\t\tacs_ads: '300',\n\t\t\tacs_mongodb: '300',\n\t\t\tacs_express_connect: '60',\n\t\t\tacs_fc: '60',\n\t\t\tacs_nat_gateway: '60'\n\t\t};\n\t}\n\n\tquery(options) {\n\t\tconsole.log(\"hello\", options)\n\t\tvar paramPattern = \"/?Action=QueryMetricList&Project={Project}&Metric={Metric}&Period={Period}&\" +\n\t\t\t\"StartTime={StartTime}&EndTime={EndTime}&Dimensions={Dimensions}&Length=1000\";\n\t\tvar start = new Date(options.range.from).getTime();\n\t\tvar end = new Date(options.range.to).getTime();\n\t\tvar queries = [];\n\t\t_(options.targets).forEach(target => {\n\t\t\tif(!target.project && target.project === '' && !target.metric && target.metric === '') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar query = {};\n\t\t\tquery.Project = target.project;\n\t\t\tquery.Metric = target.metric;\n\t\t\tvar period = target.period;\n\t\t\tif(period && period > 0 && period % this.loadDefaultPeroid(target.project, target.metric) === 0) {\n\t\t\t\tquery.Period = period;\n\t\t\t} else {\n\t\t\t\tquery.Period = '';\n\t\t\t}\n\t\t\tquery.StartTime = start;\n\t\t\tquery.EndTime = end;\n\n\t\t\tvar dimension = {};\n\t\t\t_.each(target.dimensions, function(dim) {\n\t\t\t\tif(dim.value && dim.value !== '') {\n\t\t\t\t\t//dimension[dim.key] = this.templateSrv.replace(dim.value);\n\t\t\t\t\tdimension[dim.key] = dim.value;\n\t\t\t\t}\n\t\t\t});\n\t\t\tquery.Dimensions = JSON.stringify(dimension);\n\n\t\t\t_.each(_.keys(query), key => {\n\t\t\t\tparamPattern = paramPattern.replace('{' + key + '}', this.uriEscape(query[key]));\n\t\t\t});\n\n\t\t\tvar param = {\n\t\t\t\tpath: paramPattern,\n\t\t\t\tmethod: \"GET\"\n\t\t\t};\n\t\t\tqueries.push(this.buildRealUrl(param));\n\t\t});\n\n\t\tif(_.isEmpty(queries)) {\n\t\t\tvar d = this.q.defer();\n\t\t\td.resolve({\n\t\t\t\tdata: []\n\t\t\t});\n\t\t\treturn d.promise;\n\t\t}\n\n\t\tvar allQueryPromise = _.map(queries, function(query) {\n\t\t\tvar options = {\n\t\t\t\tmethod: 'GET',\n\t\t\t\turl: query,\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn this.backendSrv.datasourceRequest(options);\n\t\t}.bind(this));\n\n\t\treturn this.q.all(allQueryPromise).then(function(allResponse) {\n\t\t\tvar result = [];\n\t\t\t_.each(allResponse, function(response, index) {\n\t\t\t\tvar target = options.targets[index];\n\t\t\t\tvar selectedFieldNames = target.selectedFieldNames;\n\t\t\t\tvar resResult = [];\n\t\t\t\t_.each(selectedFieldNames, selectedFieldName => {\n\t\t\t\t\tvar datapoints = [];\n\t\t\t\t\tvar Datapoints = JSON.parse(response.data.Datapoints);\n\t\t\t\t\t_.each(Datapoints, Datapoint => {\n\t\t\t\t\t\tlet datapoint = [];\n\t\t\t\t\t\tdatapoint.push(Datapoint[selectedFieldName], Datapoint.timestamp);\n\t\t\t\t\t\tdatapoints.push(datapoint);\n\t\t\t\t\t});\n\t\t\t\t\tresResult.push({\n\t\t\t\t\t\t\"target\": selectedFieldName,\n\t\t\t\t\t\t\"datapoints\": datapoints\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tresult = result.concat(typeof resResult == 'string' ? JSON.parse(resResult) : resResult);\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tdata: result\n\t\t\t};\n\t\t});\n\t}\n\n\turiEscape(string) {\n\t\tvar output = encodeURIComponent(string);\n\t\toutput = output.replace(/[^A-Za-z0-9_.~\\-%]+/g, escape);\n\t\toutput = output.replace(/[*]/g, function(ch) {\n\t\t\treturn '%' + ch.charCodeAt(0).toString(16).toUpperCase();\n\t\t});\n\t\treturn output;\n\t}\n\n\tListProjectDetail() {\n\t\tvar param = {\n\t\t\tpath: \"/?Action=QueryProjectMeta&PageSize=1000\",\n\t\t\tmethod: \"GET\"\n\t\t};\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.buildRealUrl(param),\n\t\t\tmethod: 'GET'\n\t\t}).then(response => {\n\t\t\tvar data = response.data;\n\t\t\tvar result = [];\n\t\t\t_.each(data.Resources.Resource, Resource => {\n\t\t\t\tresult.push(Resource.Project);\n\t\t\t});\n\t\t\treturn result;\n\t\t});\n\t}\n\n\tListMetricDetail(parameters) {\n\t\tvar paramPattern = \"/?Action=QueryMetricMeta&Project={Project}&Metric={Metric}&PageSize=1000\";\n\t\t_.each(_.keys(parameters), key => {\n\t\t\tparamPattern = paramPattern.replace('{' + key + '}', this.uriEscape(parameters[key]));\n\t\t});\n\t\tvar param = {\n\t\t\tpath: paramPattern,\n\t\t\tmethod: \"GET\"\n\t\t};\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.buildRealUrl(param),\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json'\n\t\t\t}\n\t\t});\n\t}\n\n\t//\tgetGroupList() {\n\t//\t\tvar param = {\n\t//\t\t\tpath: \"/?Action=ListMyGroups\",\n\t//\t\t\tmethod: \"GET\"\n\t//\t\t};\n\t//\t\treturn this.backendSrv.datasourceRequest({\n\t//\t\t\turl: this.buildRealUrl(param),\n\t//\t\t\tmethod: 'GET'\n\t//\t\t}).then(response => {\n\t//\t\t\tvar data = response.data;\n\t//\t\t\tvar result = [];\n\t//\t\t\t_.each(data.Resources.Resource, Group => {\n\t//\t\t\t\tlet group = [];\n\t//\t\t\t\tgroup.push(Group.GroupName, Group.GroupId);\n\t//\t\t\t\tresult.push(group.join(\"/\"));\n\t//\t\t\t});\n\t//\t\t\treturn result;\n\t//\t\t});\n\t//\t}\n\n\tlistDimensionValues(query) {\n\t\tvar paramPattern = \"/?Action=QueryMetricLast&Project={Project}&Metric={Metric}&Period={Period}&\" +\n\t\t\t\"StartTime={StartTime}&EndTime={EndTime}&Dimensions={Dimensions}\";\n\t\tvar dimensions = {};\n\t\tfor(var index in query.Dimensions) {\n\t\t\tvar dim = query.Dimensions[index];\n\t\t\tif(dim.value && dim.value !== '') {\n\t\t\t\tdimensions[dim.key] = this.templateSrv.replace(dim.value);\n\t\t\t}\n\t\t}\n\t\tquery.Dimensions = JSON.stringify(dimensions);\n\t\tif(!query.Period || query.Period === '') {\n\t\t\tif(this.loadDefaultPeroid(query.Project, query.Metric) === undefined) {\n\t\t\t\tquery.Period = '';\n\t\t\t} else {\n\t\t\t\tquery.Period = this.loadDefaultPeroid(query.Project, query.Metric);\n\t\t\t}\n\t\t}\n\t\t_.each(_.keys(query), key => {\n\t\t\tparamPattern = paramPattern.replace('{' + key + '}', this.uriEscape(query[key]));\n\t\t});\n\t\tvar param = {\n\t\t\tpath: paramPattern,\n\t\t\tmethod: \"GET\"\n\t\t};\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.buildRealUrl(param),\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json'\n\t\t\t}\n\t\t}).then(response => {\n\t\t\tvar data = response.data;\n\t\t\tif(data.Code == 200) {\n\t\t\t\tlet dimList = [];\n\t\t\t\tvar Datapoints = JSON.parse(response.data.Datapoints);\n\t\t\t\t_.each(Datapoints, Datapoint => {\n\t\t\t\t\tdimList.push(Datapoint[query.NextKey]);\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tdata: dimList\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n\n\ttestDatasource() {\n\t\tvar param = {\n\t\t\tpath: \"/?Action=QueryMetricList&Project=acs_ecs_dashboard&Metric=cpu_idle&Length=1\",\n\t\t\tmethod: \"GET\"\n\t\t};\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.buildRealUrl(param),\n\t\t\tmethod: 'GET'\n\t\t}).then(response => {\n\t\t\tvar data = response.data;\n\t\t\tif(data.Code == 200) {\n\t\t\t\treturn {\n\t\t\t\t\tstatus: \"success\",\n\t\t\t\t\tmessage: \"Data source is working\",\n\t\t\t\t\ttitle: \"Success\"\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n\n\tmetricFindQuery(query) {\n\t\tvar paramPattern = \"/?Action=QueryMetricLast&Project={Project}&Metric={Metric}&Period={Period}&\" +\n\t\t\t\"StartTime={StartTime}&EndTime={EndTime}&Dimensions={Dimensions}\";\n\t\tvar items = query.match(/^dimension_values\\((.*)\\)/);\n\t\tvar dimensionValues = [];\n\t\t_.each(items[1].split(\",\"), i => {\n\t\t\tdimensionValues.push(i.match(/\"(.*)\"/)[1]);\n\t\t});\n\t\tvar pm = dimensionValues[0];\n\t\tif(!pm || pm.indexOf('/') === -1) {\n\t\t\treturn;\n\t\t}\n\t\tvar arr = pm.split(\"/\");\n\t\tvar dimensionKeys = _.filter([\"userId\", \"instanceId\"], key => {\n\t\t\treturn key !== 'userId';\n\t\t});\n\t\tvar dimension = {};\n\t\tvar j = 1;\n\t\tfor(var k in dimensionKeys) {\n\t\t\tvar key = dimensionKeys[k];\n\t\t\tif(dimensionValues[j]) {\n\t\t\t\tdimension[key] = this.templateSrv.replace(dimensionValues[j]);\n\t\t\t\tj++;\n\t\t\t}\n\t\t}\n\t\tif(!dimensionKeys[j - 1]) {\n\t\t\treturn [];\n\t\t}\n\t\tvar param = {};\n\t\tparam.Project = arr[0];\n\t\tparam.Metric = arr[1];\n\t\tparam.Period = this.loadDefaultPeroid(arr[0], arr[1]);\n\t\tvar now = new Date();\n\t\tparam.StartTime = now.getTime() - 1000 * 60 * 60;\n\t\tparam.EndTime = now.getTime();\n\t\tparam.Dimensions = JSON.stringify(dimension);\n\t\t_.each(_.keys(param), key => {\n\t\t\tparamPattern = paramPattern.replace('{' + key + '}', this.uriEscape(param[key]));\n\t\t});\n\t\tvar param = {\n\t\t\tpath: paramPattern,\n\t\t\tmethod: \"GET\"\n\t\t};\n\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.buildRealUrl(param),\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json'\n\t\t\t}\n\t\t}).then(response => {\n\t\t\tvar data = response.data;\n\t\t\tif(data.Code == 200) {\n\t\t\t\tlet dimList = [];\n\t\t\t\t_.each(response.data.Datapoints, Datapoint => {\n\t\t\t\t\tdimList.push(Datapoint[dimensionKeys[j - 1]]);\n\t\t\t\t});\n\t\t\t\treturn this.mapToTextValue(dimList);\n\t\t\t}\n\t\t});\n\t}\n\n\tmapToTextValue(result) {\n\t\treturn _.map(result, (d, i) => {\n\t\t\tif(d && d.text && d.value) {\n\t\t\t\treturn {\n\t\t\t\t\ttext: d.text,\n\t\t\t\t\tvalue: d.value\n\t\t\t\t};\n\t\t\t} else if(_.isObject(d)) {\n\t\t\t\treturn {\n\t\t\t\t\ttext: d,\n\t\t\t\t\tvalue: i\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\ttext: d,\n\t\t\t\tvalue: d\n\t\t\t};\n\t\t});\n\t}\n\n\tloadDefaultPeroid(project, metric) {\n\t\tif(project === 'acs_ecs_dashboard' &&\n\t\t\tmetric.indexOf('_') > 0 &&\n\t\t\tmetric.indexOf('InternetOutRate') === -1 &&\n\t\t\tmetric.indexOf('VPC') === -1) {\n\t\t\treturn '15';\n\t\t} else {\n\t\t\treturn this.default_period[project];\n\t\t}\n\t}\n\n\tbuildRealUrl(param) {\n\t\tvar signer = new CmsSigner({\n\t\t\taccessKeyId: this.jsonData.cmsAccessKey,\n\t\t\tsecretAccessKey: this.jsonData.cmsSecretKey\n\t\t}, param);\n\t\tsigner.addAuthorization();\n\t\treturn this.basePath + signer.request.path;\n\t}\n}"]}